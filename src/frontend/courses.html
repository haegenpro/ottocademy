<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Courses - Grocademy</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="bg-background">
    <div class="min-h-screen flex flex-col">
        <nav class="nav">
            <div class="container">
                <div class="flex items-center justify-between h-20">
                    <a href="index.html" class="flex items-center gap-2 text-2xl font-bold text-primary">
                        <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center text-xl">üçå</div>
                        <span>Grocademy</span>
                    </a>
                    <ul class="flex items-center space-x-6">
                        <li><a href="courses.html" class="nav-link active">Browse Courses</a></li>
                        <li><a href="my-courses.html" class="nav-link">My Courses</a></li>
                        <li>
                            <div class="text-sm">
                                <div id="userBalance" class="text-primary font-semibold">Balance: Loading...</div>
                            </div>
                        </li>
                        <li><a href="profile.html" class="flex items-center justify-center w-8 h-8 bg-primary/20 rounded-full hover:bg-primary/30 transition-colors">üë§</a></li>
                        <li><button onclick="logout()" class="btn btn-outline btn-sm">Logout</button></li>
                    </ul>
                </div>
            </div>
        </nav>

        <main class="flex-1 container py-12">
            <section class="text-center mb-12">
                <h1 class="text-5xl font-extrabold mb-4">Discover Amazing Courses</h1>
                <p class="text-lg text-muted-foreground max-w-3xl mx-auto">
                    Learn with the Minions and expand your skills with our comprehensive course library.
                </p>
            </section>

            <section class="mb-8 p-6 card">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="searchInput" class="label mb-2 block">Search Course</label>
                        <input type="text" id="searchInput" class="input" placeholder="Search by title, instructor, or topic...">
                    </div>
                    <div>
                        <label for="categoryFilter" class="label mb-2 block">Category</label>
                        <select id="categoryFilter" class="input w-full">
                            <option value="">All Categories</option>
                            <option value="COMPUTER_SCIENCE">Computer Science</option>
                            <option value="BUSINESS">Business</option>
                            <option value="DATA_SCIENCE">Data Science</option>
                            <option value="DESIGN">Design</option>
                            <option value="MARKETING">Marketing</option>
                        </select>
                    </div>
                    <div>
                        <label for="limitSelect" class="label mb-2 block">Show</label>
                        <select id="limitSelect" class="input w-full">
                            <option value="10">10 per page</option>
                            <option value="20">20 per page</option>
                            <option value="50">50 per page</option>
                        </select>
                    </div>
                    <div>
                        <button id="searchBtn" class="btn btn-primary w-full">Search</button>
                    </div>
                </div>
                
                <!-- Results Info -->
                <div id="resultsInfo" class="mt-4 text-sm text-muted-foreground hidden">
                    Showing results...
                </div>
            </section>

            <div id="loadingSpinner" class="text-center py-16">
                <div class="spinner w-12 h-12 mx-auto mb-4"></div>
                <p class="text-muted-foreground">Loading courses...</p>
            </div>

            <section id="courseGrid" class="grid grid-cols-1 md:grid-cols-2 gap-8 hidden">
                </section>

            <section id="noResults" class="text-center py-16 hidden">
                <div class="text-6xl mb-4">ü§∑</div>
                <h3 class="text-2xl font-semibold mb-2">No Courses Found</h3>
                <p class="text-muted-foreground mb-6">Try adjusting your search filters to find what you're looking for.</p>
                <button onclick="clearFilters()" class="btn btn-primary btn-lg">Clear Filters</button>
            </section>

            <section id="pagination" class="flex justify-center mt-12"></section>
        </main>
        
        <footer class="bg-muted/50 border-t py-8 mt-12">
            <div class="container text-center text-muted-foreground">
                <p>¬© 2025 Grocademy. All Rights Reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <script src="js/api.js"></script>
    <script>
        let currentPage = 1;
        let currentLimit = 12;
        let currentSearch = '';
        let currentCategory = '';
        let totalPages = 1;

        if (!requireAuth()) {
            throw new Error('Authentication required');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await loadCourses();
            setupEventListeners();
        });

        async function loadUserInfo() {
            try {
                if (!isAuthenticated()) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                const response = await api.getProfile();
                const profile = response.data;
                
                const balance = profile.balance || 0;
                document.getElementById('userBalance').textContent = `Balance: ${formatCurrency(balance)}`;
            } catch (error) {
                console.error('Failed to load user info:', error);
                
                if (error.message === 'Authentication required') {
                    window.location.href = 'auth.html';
                    return;
                }
                
                document.getElementById('userBalance').textContent = 'Balance: --';
                showToast('Unable to load user profile', 'warning');
            }
        }

        async function loadCourses() {
            const spinner = document.getElementById('loadingSpinner');
            const grid = document.getElementById('courseGrid');
            const noResults = document.getElementById('noResults');
            const pagination = document.getElementById('pagination');
            
            spinner.classList.remove('hidden');
            grid.classList.add('hidden');
            noResults.classList.add('hidden');
            pagination.classList.add('hidden');

            try {
                if (!isAuthenticated()) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                const response = await api.getCourses(currentPage, currentLimit, currentSearch, currentCategory);
                const courses = response.data || response.courses || response;
                const meta = response.pagination || response.meta || {};

                if (Array.isArray(courses) && courses.length > 0) {
                    displayCourses(courses);
                    updateResultsInfo(meta);
                    updatePagination(meta);
                    
                    grid.classList.remove('hidden');
                    if (totalPages > 1) {
                        pagination.classList.remove('hidden');
                    }
                } else {
                    noResults.classList.remove('hidden');
                    updateResultsInfo({ total: 0 });
                }

            } catch (error) {
                console.error('Failed to load courses:', error);
                
                if (error.message === 'Authentication required') {
                    return;
                }
                
                showToast('Failed to load courses. Please try again.', 'error');
                noResults.classList.remove('hidden');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        function displayCourses(courses) {
            const grid = document.getElementById('courseGrid');
            grid.innerHTML = '';

            courses.forEach(course => {
                const courseCard = createCourseCard(course);
                grid.appendChild(courseCard);
            });
        }

        function createCourseCard(course) {
            const card = document.createElement('div');
            card.className = 'card overflow-hidden flex flex-col group transition-all duration-300 hover:shadow-xl hover:-translate-y-1';
            
            const price = course.price === 0 ? 'Free' : formatCurrency(course.price);
            const isPurchased = course.isPurchased || course.is_purchased;
            
            const createImageElement = (course) => {
                if (course.thumbnail_image) {
                    return `<img src="${course.thumbnail_image}" 
                                 alt="${course.title}" 
                                 class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                                 loading="lazy">`;
                } else {
                    return `<div class="w-full h-full bg-gradient-to-br from-primary/20 to-primary/40 flex items-center justify-center">
                        <span class="text-primary font-semibold text-4xl">üìö</span>
                    </div>`;
                }
            };

            card.innerHTML = `
                <div class="relative overflow-hidden">
                    <div class="h-56 bg-gradient-minion flex items-center justify-center">
                        ${createImageElement(course)}
                    </div>
                    <div class="absolute top-4 right-4 badge ${isPurchased ? 'bg-secondary text-secondary-foreground' : 'bg-primary text-primary-foreground'} font-bold text-sm">
                        ${isPurchased ? 'Enrolled' : price}
                    </div>
                </div>

                <div class="p-6 flex flex-col flex-grow">
                    <div class="flex-grow">
                        <div class="badge badge-outline mb-3">${course.category || 'General'}</div>
                        <h3 class="text-xl font-bold mb-2 leading-snug">${course.title}</h3>
                        <p class="text-sm text-muted-foreground">By ${course.instructor}</p>
                    </div>
                    
                    <div class="mt-6">
                        <button class="btn btn-primary w-full btn-md">
                            View Details
                        </button>
                    </div>
                </div>
            `;

            card.onclick = () => viewCourse(course.id);
            
            return card;
        }

        function updateResultsInfo(meta) {
            const info = document.getElementById('resultsInfo');
            const total = meta.total_items || meta.total || 0;
            const currentShowing = Math.min(currentLimit, total);
            const startItem = total > 0 ? ((currentPage - 1) * currentLimit) + 1 : 0;
            const endItem = Math.min(startItem + currentShowing - 1, total);
            
            info.textContent = `Showing ${startItem}-${endItem} of ${total} courses`;
            info.classList.remove('hidden');
        }

        function updatePagination(meta) {
            const pagination = document.getElementById('pagination');
            totalPages = meta.total_pages || meta.totalPages || Math.ceil((meta.total_items || meta.total || 0) / currentLimit);
            
            if (totalPages <= 1) {
                pagination.classList.add('hidden');
                return;
            }

            let paginationHTML = '<div class="flex items-center gap-2">';
            
            paginationHTML += `
                <button onclick="changePage(${currentPage - 1})" 
                        class="btn btn-outline btn-sm ${currentPage <= 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${currentPage <= 1 ? 'disabled' : ''}>
                    ‚Üê Previous
                </button>
            `;
            
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<button onclick="changePage(1)" class="btn btn-outline btn-sm">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="px-2">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button onclick="changePage(${i})" 
                            class="btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline'}">
                        ${i}
                    </button>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="px-2">...</span>`;
                }
                paginationHTML += `<button onclick="changePage(${totalPages})" class="btn btn-outline btn-sm">${totalPages}</button>`;
            }
            
            paginationHTML += `
                <button onclick="changePage(${currentPage + 1})" 
                        class="btn btn-outline btn-sm ${currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${currentPage >= totalPages ? 'disabled' : ''}>
                    Next ‚Üí
                </button>
            `;
            
            paginationHTML += '</div>';
            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadCourses();
        }

        function performSearch() {
            currentSearch = document.getElementById('searchInput').value.trim();
            currentCategory = document.getElementById('categoryFilter').value;
            currentPage = 1;
            loadCourses();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            currentSearch = '';
            currentCategory = '';
            currentPage = 1;
            loadCourses();
        }

        function viewCourse(courseId) {
            window.location.href = `course-detail.html?id=${courseId}`;
        }

        function setupEventListeners() {
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            document.getElementById('categoryFilter').addEventListener('change', performSearch);
            
            document.getElementById('limitSelect').addEventListener('change', (e) => {
                currentLimit = parseInt(e.target.value);
                currentPage = 1;
                loadCourses();
            });

            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(performSearch, 500);
            });
        }
    </script>

    <!-- Footer -->
    <footer class="bg-muted/30 border-t py-6 mt-12">
        <div class="container">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center space-x-2">
                    <div class="text-2xl">üçå</div>
                    <span class="font-bold text-primary">Grocademy</span>
                </div>
                <div class="text-sm text-muted-foreground text-center md:text-right">
                    <p>¬© 2025 Grocademy. Learn with the Minions!</p>
                    <div class="flex items-center justify-center md:justify-end gap-4 mt-2">
                        <a href="#" class="hover:text-primary transition-colors">Terms</a>
                        <a href="#" class="hover:text-primary transition-colors">Privacy</a>
                        <a href="#" class="hover:text-primary transition-colors">Support</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>
