<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Courses - Grocademy</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-background">
    <nav class="nav">
        <div class="container">
            <div class="flex items-center justify-between h-20">
                <a href="index.html" class="flex items-center gap-2 text-2xl font-bold text-primary">
                    <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center text-xl">üçå</div>
                    <span>Grocademy</span>
                </a>
                <ul class="flex items-center space-x-6">
                    <li><a href="courses.html" class="nav-link">Browse Courses</a></li>
                    <li><a href="my-courses.html" class="nav-link active">My Courses</a></li>
                    <li>
                        <div class="text-sm">
                            <div id="userBalance" class="text-primary font-semibold">Balance: Loading...</div>
                        </div>
                    </li>
                    <li><a href="profile.html" class="flex items-center justify-center w-8 h-8 bg-primary/20 rounded-full hover:bg-primary/30 transition-colors">üë§</a></li>
                    <li><button onclick="logout()" class="btn btn-outline btn-sm">Logout</button></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="flex-1 container py-12">
        <section class="mb-12">
            <h1 class="text-5xl font-extrabold mb-4">My Learning</h1>
            <p class="text-lg text-muted-foreground">Continue your journey and complete your courses.</p>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div class="card p-6 flex items-center gap-4">
                <div class="text-3xl">üìö</div>
                <div>
                    <div class="text-3xl font-bold" id="totalCourses">0</div>
                    <div class="text-muted-foreground">Courses Enrolled</div>
                </div>
            </div>
            <div class="card p-6 flex items-center gap-4">
                <div class="text-3xl">üéâ</div>
                <div>
                    <div class="text-3xl font-bold text-green-600" id="completedCourses">0</div>
                    <div class="text-muted-foreground">Completed</div>
                </div>
            </div>
            <div class="card p-6 flex items-center gap-4">
                <div class="text-3xl">üèÉ</div>
                <div>
                    <div class="text-3xl font-bold text-blue-600" id="inProgressCourses">0</div>
                    <div class="text-muted-foreground">In Progress</div>
                </div>
            </div>
        </section>
        
        <!-- Search and Filter Section -->
        <section class="mb-8 p-6 card">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="md:col-span-2">
                    <label for="searchInput" class="label mb-2 block">Search Courses</label>
                    <input type="text" id="searchInput" class="input" placeholder="Search by title, instructor...">
                </div>
                <div>
                    <label for="statusFilter" class="label mb-2 block">Status</label>
                    <select id="statusFilter" class="input w-full">
                        <option value="">All Status</option>
                        <option value="not-started">Not Started</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div>
                    <button id="searchBtn" class="btn btn-primary w-full">Filter</button>
                </div>
            </div>
            
            <!-- Results Info -->
            <div id="resultsInfo" class="mt-4 text-sm text-muted-foreground hidden">
                Showing results...
            </div>
        </section>
        
        <div id="loadingSpinner" class="text-center py-16">...</div>
        <section id="coursesGrid" class="grid grid-cols-1 md:grid-cols-2 gap-8 hidden"></section>
        <section id="emptyState" class="text-center py-16 hidden">
            <div class="text-6xl mb-4">üéí</div>
            <h3 class="text-2xl font-semibold mb-2">Your backpack is empty!</h3>
            <p class="text-muted-foreground mb-6">You haven't enrolled in any courses yet. Let's find something new to learn.</p>
            <a href="courses.html" class="btn btn-primary btn-lg">Browse Courses</a>
        </section>
        <section id="pagination" class="flex justify-center mt-12"></section>
    </main>
    
    <div id="toast-container"></div>
    <script src="js/api.js"></script>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <script src="js/api.js"></script>
    <script>
        let currentPage = 1;
        let currentLimit = 12;
        let currentSearch = '';
        let currentStatus = '';
        let totalPages = 1;
        let allCourses = [];

        if (!requireAuth()) {
            throw new Error('Authentication required');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await loadMyCourses();
            setupEventListeners();
        });

        async function loadUserInfo() {
            try {
                if (!isAuthenticated()) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                const profile = await api.getProfile();
                
                const balance = profile.balance || 0;
                document.getElementById('userBalance').textContent = `Balance: ${formatCurrency(balance)}`;
            } catch (error) {
                console.error('Failed to load user info:', error);
                
                if (error.message === 'Authentication required') {
                    return;
                }
                
                document.getElementById('userBalance').textContent = 'Balance: --';
                showToast('Unable to load user profile', 'warning');
            }
        }

        async function loadMyCourses() {
            const spinner = document.getElementById('loadingSpinner');
            const grid = document.getElementById('coursesGrid');
            const emptyState = document.getElementById('emptyState');
            const pagination = document.getElementById('pagination');
            
            spinner.classList.remove('hidden');
            grid.classList.add('hidden');
            emptyState.classList.add('hidden');
            pagination.classList.add('hidden');

            try {
                const response = await api.getMyCourses(currentPage, currentLimit);
                const courses = response.data || response.courses || response;
                const meta = response.meta || response.pagination || {};

                allCourses = Array.isArray(courses) ? courses : [];

                if (allCourses.length > 0) {
                    const filteredCourses = filterCourses(allCourses);
                    
                    if (filteredCourses.length > 0) {
                        displayCourses(filteredCourses);
                        updateStats(allCourses);
                        updateResultsInfo({ total: filteredCourses.length });
                        updatePagination(meta);
                        
                        grid.classList.remove('hidden');
                        if (totalPages > 1) {
                            pagination.classList.remove('hidden');
                        }
                    } else {
                        emptyState.classList.remove('hidden');
                        updateStats(allCourses);
                        updateResultsInfo({ total: 0 });
                    }
                } else {
                    emptyState.classList.remove('hidden');
                    updateStats([]);
                    updateResultsInfo({ total: 0 });
                }

            } catch (error) {
                console.error('Failed to load courses:', error);
                
                if (error.message === 'Authentication required') {
                    return;
                }
                
                showToast('Failed to load your courses. Please try again.', 'error');
                emptyState.classList.remove('hidden');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        function filterCourses(courses) {
            let filtered = courses;

            if (currentSearch) {
                filtered = filtered.filter(course => 
                    course.title.toLowerCase().includes(currentSearch.toLowerCase()) ||
                    course.instructor.toLowerCase().includes(currentSearch.toLowerCase()) ||
                    (course.topics && course.topics.some(topic => 
                        topic.toLowerCase().includes(currentSearch.toLowerCase())
                    ))
                );
            }

            if (currentStatus) {
                filtered = filtered.filter(course => {
                    const progress = getCourseProgress(course);
                    switch (currentStatus) {
                        case 'completed':
                            return progress === 100;
                        case 'in-progress':
                            return progress > 0 && progress < 100;
                        case 'not-started':
                            return progress === 0;
                        default:
                            return true;
                    }
                });
            }

            return filtered;
        }

        function getCourseProgress(course) {
            if (typeof course.progress_percentage === 'number') {
                return course.progress_percentage;
            }
            
            const modules = course.modules || course.Module || [];
            if (!modules || modules.length === 0) return 0;
            
            const completedModules = modules.filter(m => {
                return m.isCompleted || m.is_completed || 
                       (m.ModuleCompletion && m.ModuleCompletion.length > 0) ||
                       (m.moduleCompletion && m.moduleCompletion.length > 0);
            });
            
            return Math.round((completedModules.length / modules.length) * 100);
        }

        function displayCourses(courses) {
            const grid = document.getElementById('coursesGrid');
            grid.innerHTML = '';

            courses.forEach(course => {
                const courseCard = createCourseCard(course);
                grid.appendChild(courseCard);
            });
        }

        function createCourseCard(course) {
            const card = document.createElement('div');
            card.className = 'card course-card overflow-hidden transition-all duration-300 hover:shadow-xl hover:-translate-y-2';
            
            const progress = getCourseProgress(course);
            const buttonText = progress === 0 ? 'Start Learning' : progress === 100 ? 'Review Course' : 'Continue Learning';
            
            const createImageElement = (course) => {
                if (course.thumbnail_image) {
                    return `<img src="${course.thumbnail_image}" 
                                 alt="${course.title}" 
                                 class="w-full h-full object-cover"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                 loading="lazy">
                            <div class="w-full h-full bg-gradient-to-br from-primary/20 to-primary/40 flex items-center justify-center text-4xl" style="display: none;">
                                üìö
                            </div>`;
                } else {
                    return `<div class="w-full h-full bg-gradient-to-br from-primary/20 to-primary/40 flex items-center justify-center text-4xl">
                                üìö
                            </div>`;
                }
            };
            
            card.innerHTML = `
                <div class="h-48 bg-gradient-minion flex items-center justify-center">
                     ${createImageElement(course)}
                </div>
                <div class="p-6">
                    <h3 class="text-lg font-bold mb-2 h-14">${course.title}</h3>
                    <p class="text-sm text-muted-foreground mb-4">By ${course.instructor}</p>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-xs text-muted-foreground">
                            <span>Progress</span>
                            <span class="font-semibold">${progress}%</span>
                        </div>
                        <div class="w-full bg-muted rounded-full h-2.5">
                            <div class="bg-primary h-2.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                    </div>

                    <button onclick="continueCourse('${course.id}')" 
                            class="btn btn-primary w-full btn-md transition-all duration-200 hover:bg-primary/80 hover:scale-105 active:scale-95"
                            data-course-id="${course.id}">
                        ${buttonText}
                    </button>
                </div>
            `;
            return card;
        }

        function getStatusBadge(progress) {
            let badgeClass, badgeText;
            
            if (progress === 100) {
                badgeClass = 'bg-green-100 text-green-800';
                badgeText = '‚úÖ Completed';
            } else if (progress > 0) {
                badgeClass = 'bg-blue-100 text-blue-800';
                badgeText = 'üìñ In Progress';
            } else {
                badgeClass = 'bg-gray-100 text-gray-800';
                badgeText = 'üÜï Not Started';
            }

            return `<div class="absolute top-2 right-2 badge ${badgeClass} text-xs">${badgeText}</div>`;
        }

        function updateStats(courses) {
            const total = courses.length;
            const completed = courses.filter(course => getCourseProgress(course) === 100).length;
            const inProgress = courses.filter(course => {
                const progress = getCourseProgress(course);
                return progress > 0 && progress < 100;
            }).length;

            document.getElementById('totalCourses').textContent = total;
            document.getElementById('completedCourses').textContent = completed;
            document.getElementById('inProgressCourses').textContent = inProgress;
        }

        function updateProgress(course) {
            const progress = getCourseProgress(course);
            
            const courseCard = document.querySelector(`[data-course-id="${course.id}"]`);
            if (courseCard) {
                const progressBar = courseCard.closest('.card').querySelector('.bg-primary');
                const progressText = courseCard.closest('.card').querySelector('.font-semibold');
                
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }
                if (progressText) {
                    progressText.textContent = `${progress}%`;
                }
            }
        }

        function updateResultsInfo(meta) {
            const info = document.getElementById('resultsInfo');
            const total = meta.total || 0;
            
            if (total > 0) {
                info.textContent = `Showing ${total} course${total !== 1 ? 's' : ''}`;
                info.classList.remove('hidden');
            } else {
                info.textContent = 'No courses found';
                info.classList.remove('hidden');
            }
        }

        function updatePagination(meta) {
            const pagination = document.getElementById('pagination');
            totalPages = meta.totalPages || Math.ceil((meta.total || 0) / currentLimit);
            
            if (totalPages <= 1) {
                pagination.classList.add('hidden');
                return;
            }

            let paginationHTML = '<div class="flex items-center gap-2">';
            
            paginationHTML += `
                <button onclick="changePage(${currentPage - 1})" 
                        class="btn btn-outline btn-sm ${currentPage <= 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${currentPage <= 1 ? 'disabled' : ''}>
                    ‚Üê Previous
                </button>
            `;
            
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button onclick="changePage(${i})" 
                            class="btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline'}">
                        ${i}
                    </button>
                `;
            }
            
            paginationHTML += `
                <button onclick="changePage(${currentPage + 1})" 
                        class="btn btn-outline btn-sm ${currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${currentPage >= totalPages ? 'disabled' : ''}>
                    Next ‚Üí
                </button>
            `;
            
            paginationHTML += '</div>';
            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadMyCourses();
        }

        function performSearch() {
            currentSearch = document.getElementById('searchInput').value.trim();
            currentStatus = document.getElementById('statusFilter').value;
            currentPage = 1;
            loadMyCourses();
        }

        function continueCourse(courseId) {
            console.log('continueCourse called with courseId:', courseId);
            
            if (!courseId) {
                console.error('No courseId provided');
                showToast('Course ID not found', 'error');
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Loading...';
            button.disabled = true;
            
            setTimeout(() => {
                window.location.href = `module.html?courseId=${courseId}`;
            }, 500);
        }

        function viewCourseDetails(courseId) {
            window.location.href = `course-detail.html?id=${courseId}`;
        }

        async function downloadCertificate(courseId) {
            try {
                await api.downloadCertificate(courseId);
                showToast('Certificate download started!', 'success');
            } catch (error) {
                console.error('Certificate download failed:', error);
                showToast('Failed to download certificate. Please try again.', 'error');
            }
        }

        function setupEventListeners() {
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            document.getElementById('statusFilter').addEventListener('change', performSearch);

            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(performSearch, 500);
            });
        }

        function showToast(message, type = 'info') {
            console.log(`Toast [${type}]: ${message}`);
            
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white max-w-sm transform transition-all duration-300 translate-x-full`;
            
            switch(type) {
                case 'error':
                    toast.className += ' bg-red-500';
                    break;
                case 'warning':
                    toast.className += ' bg-yellow-500';
                    break;
                case 'success':
                    toast.className += ' bg-green-500';
                    break;
                default:
                    toast.className += ' bg-blue-500';
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
